box: golang:1.4
build:
    steps:
        - setup-go-workspace

        - script:
            name: go get
            code: go get ./...

        - script:
            name: go build
            code: go build

        - script:
            name: go test
            code: go test

deploy:
    steps:
        - mktemp:
            envvar: ACTOOL_PATH

        - script:
            name: install dependencies
            code: |
                go get github.com/appc/goaci
                wget https://github.com/appc/spec/releases/download/v0.7.0/appc-v0.7.0.tar.gz
                tar -xvf appc-v0.7.0.tar.gz -C $ACTOOL_PATH

        - script:
            name: create ACI
            code: goaci go github.com/blau-io/proxii

        - script:
            name: patch ACI
            code: |
                cd $ACTOOL_PATH
                ./actool patch-manifest --replace -mounts=certs,path=/certs,readOnly=true proxii.aci

        - mktemp:
            envvar: PRIVATEKEY_PATH

        - create-file:
            name: write keyfile
            filename: $PRIVATEKEY_PATH
            content: $SSH_PRIVATE
            overwrite: true
            hide-from-log: true

        - create-file:
            name: create service file
            filename: proxii.service
            content: $SERVICE
            hide-from-log: true

        - add-to-known_hosts:
            hostname: blau.io

        - script:
            name: transfer files
            code: scp -i $PRIVATEKEY_PATH proxii.service proxii.aci core@blau.io:~/

        - script:
            name: start new version
            code: |
                ssh -i $PRIVATEKEY_PATH core@blau.io '
                    fleetctl stop proxii.service;
                    fleetctl destroy proxii.service;
                    fleetctl start proxii.service;
                '

